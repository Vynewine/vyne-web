<div class="row">

  <div
  <% if current_user.has_role?(:admin) || current_user.has_role?(:superadmin) %>
  class="col-md-6"
  <% else %>
  class="col-md-12"
  <% end %>
  >

    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Summary</h3>
      </div>
      <ul class="list-group">
        <li class="list-group-item">
          <div class="row">
            <div class="col-xs-3">
              <strong>Order Id: </strong><%= @order.id %>
            </div>
            <div class="col-xs-4">
              <strong>Status:</strong> <%= @order.status.label.capitalize %>
            </div>
            <div class="col-xs-5">
              <strong>Created:</strong> <%= local_time(@order.created_at, '%b %d, %Y %l:%M %p') %>
            </div>
          </div>
        </li>
        <li class="list-group-item">
          <div class="row">
            <div class="col-xs-7">
              <strong>Merchant:</strong> <%= @order.warehouse.title %>, Address: <%= @order.warehouse.address.full %>
            </div>
            <div class="col-xs-5">
              <strong>Advisor:</strong>
              <% if @order.advisor %>
                  <%= @order.advisor.name %>
              <% else %>
                  <span class="to-do"> Not Advised </span>
              <% end %>
            </div>
          </div>
        </li>
        <li class="list-group-item">
          <div class="row">
            <div class="col-xs-12">
              <strong>Delivery:</strong>
              <% if @order.delivery_token.blank? %>
                  <span class="to-do">Delivery not scheduled</span>
              <% else %>
                  <%= @order.delivery_token %>
              <% end %>
              <% unless @order.delivery_cost.blank? %>
                  (£<%= @order.delivery_cost %>)
              <% end %>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>

  <% if user_is_admin %>
      <div class="col-md-6">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Customer Info</h3>
          </div>
          <ul class="list-group">

            <% if @order.client.blank? %>

                <li class="list-group-item">
                  <div class="row">
                    <div class="col-xs-12">
                      <strong>Client Deleted</strong>
                    </div>
                  </div>
                </li>

            <% else %>

                <li class="list-group-item">
                  <div class="row">
                    <div class="col-xs-6">
                      <strong>Name:</strong>
                      <a href="/admin/users/<%= @order.client.id %>"><%= @order.client.name %></a>
                    </div>
                    <div class="col-xs-6">
                      <strong>Mobile:</strong> <%= @order.client.mobile %>
                    </div>
                  </div>
                </li>
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-xs-6">
                      <strong>Address:</strong>
                      <% if @order.address %>
                          <%= @order.address.full %>
                      <% end %>
                    </div>
                    <div class="col-xs-6">
                      <strong>Email:</strong> <%= @order.client.email %>
                    </div>
                  </div>
                </li>
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-xs-12">
                      <strong>Payment:</strong>
                      <% if @order.charge_id.blank? %>
                          <span class="to-do">Payment not processed</span>
                      <% else %>
                          Stripe Charge Id: <%= @order.charge_id %>
                      <% end %>
                      <% unless @order.refund_id.blank? %>
                          Stripe Refund Id: <%= @order.refund_id %>
                      <% end %>
                    </div>
                  </div>
                </li>
            <% end %>
          </ul>
        </div>
      </div>
  <% end %>
</div>

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Order Items</h3>
  </div>

  <table class="table table-bordered">
    <thead>
    <tr>
      <% if @order.can_be_advised %>
          <th>Advise</th>
      <% end %>
      <th>Customer Selection</th>
      <th>Quantity</th>
      <th>Category</th>
      <th>Wine</th>
      <th>Cost</th>
      <th>Price</th>
    </tr>
    </thead>
    <tbody>
    <% @order.order_items.order(:id).each do |item| %>
        <tr>
          <% if @order.can_be_advised %>
              <td>
                <a href="/admin/advise/item/<%= item.id %>" class="btn btn-default">
                  <span class="glyphicon glyphicon-glass" aria-hidden="true"></span> <%= item.wine.nil? ? 'Advise' : 'Advised' %>
                </a>
              </td>
          <% end %>
          <td>
            <%= item.preferences.to_sentence(last_word_connector: ' and ').capitalize %>.
          </td>
          <td>x<%= item.quantity %></td>
          <td><%= item.category.name %></td>
          <td>
            <%= item.wine.nil? ? 'Not Selected' : item.wine.display_name %>
          </td>
          <td>
            £<%= item.cost %>
          </td>
          <td>
            £<%= item.price %>
          </td>
        </tr>
    <% end %>
    </tbody>
  </table>
  <div class="panel-footer">
    <div class="row">
      <div class="col-xs-6">
        <%= link_to 'Back', admin_orders_path, :class => 'btn btn-primary' %>
        <% if @order.advisory_complete && @order.status_id == Status.statuses[:pending] %>
            <%= link_to 'Finished Advice', admin_order_finished_advice_path(@order), {
                                                 :class => 'btn btn-success',
                                                 :method => :post
                                         } %>
        <% end %>
      </div>
      <div class="col-xs-6 text-right">
        <% unless @order.total_cost.nil? %>
            <strong>Cost Total: </strong>£<%= @order.total_cost %> (wine: £<%= @order.total_wine_cost %>, delivery:
            £<%= @order.delivery_cost %>)
        <% end %>
        <% unless @order.total_price.nil? %>
            <strong>Customer Price Total:</strong> £<%= @order.total_price %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% if current_user.has_role?(:admin) || current_user.has_role?(:superadmin) %>
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Admin Only</h3>
      </div>
      <ul class="list-group">
        <li class="list-group-item">
          <div class="row">
            <div class="col-xs-12">


              <% if @order.charge_id.blank? %>
                  <%= link_to 'Charge Only', admin_order_charge_path(@order), {
                                                   :class => 'btn btn-primary',
                                                   :method => :post,
                                                   :data => {:confirm => 'Are you sure? This customer will be charged £' + @order.total_price.to_s}
                                           } %>

              <% end %>
              <% if @order.delivery_token.blank? %>
                  <%= link_to 'Get Delivery Quotes', admin_advise_choose_path(:order => @order.id), {:class => 'btn btn-primary'} %>
              <% end %>
              <% if [4, 5, 6].include?(@order.status.id) %>
                  <%= link_to 'Re-Send Order Receipt', admin_order_send_receipt_path(@order), {
                                                             :class => 'btn btn-primary',
                                                             :method => :post,
                                                             :data => {:confirm => 'This will email order receipt to the client and a merchant.'}
                                                     } %>
              <% end %>
              <%= link_to 'Edit', edit_admin_order_path(@order), :class => 'btn btn-primary' %>

              <%= link_to 'Cancel', admin_order_cancel_path(@order), method: :post, data: {confirm: 'Are you sure? Payments will be refunded and Shutl will get cancelled.'}, :class => 'btn btn-warning' %>

            </div>
          </div>
        </li>
        <% unless @order.delivery_token.blank? %>
            <li class="list-group-item">
              <div class="row">
                <div class="col-md-12">
                  <strong>Delivery Information</strong>
                </div>
              </div>
            </li>
            <li class="list-group-item">
              <div class="row">
                <div class="col-md-12">
                  <a href="#" id="refresh-delivery" class="btn btn-primary" data-id="<%= @order.id %>">Refresh</a>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <% if !@order.delivery_status.nil? %>
                      <div>
                        <div id="delivery-info" style="white-space: pre; font-family: monospace;"></div>
                        <script>
                            var deliveryInfo = JSON.parse('<%= @order.delivery_status_json.html_safe %>');
                            $('#delivery-info').text(JSON.stringify(deliveryInfo, null, 4));
                        </script>
                  <% end %>
                  </div>
                </div>
              </div>
            </li>
        <% end %>
      </ul>
    </div>
<% end %>
